# QGIS 操作流程 - NYC Athletic Facilities Analysis

## 概述

本文档详细说明了在QGIS中进行空间数据处理的操作步骤，包括投影修复、缓冲区创建和地图导出。这些步骤可以作为R脚本的补充或替代方案。

## 软件要求

- **QGIS**: 版本 3.28 或更高
- **插件**: 无特殊要求，使用QGIS内置功能

## 数据准备

### 1. 导入数据文件

#### 导入Shapefile
1. 打开QGIS
2. 点击 "Layer" → "Add Layer" → "Add Vector Layer"
3. 选择 `nyct2020.shp` 文件
4. 点击 "Open"

#### 导入CSV文件
1. 点击 "Layer" → "Add Layer" → "Add Delimited Text Layer"
2. 选择 `NYC_Athletic_Selected.csv` 文件
3. 设置分隔符为 "Comma"
4. 设置X字段为 "longitude"，Y字段为 "latitude"
5. 设置坐标参考系统为 "EPSG:4326 - WGS 84"
6. 点击 "Add"

## 投影修复和转换

### 1. 检查当前投影

#### 查看图层投影信息
1. 右键点击图层名称
2. 选择 "Properties"
3. 点击 "Source" 标签
4. 查看 "Coordinate Reference System" 信息

#### 常见投影问题
- **NAD83 / New York Long Island (EPSG:2263)**: 纽约州本地投影
- **WGS 84 (EPSG:4326)**: 全球坐标系统
- **Web Mercator (EPSG:3857)**: Web地图投影

### 2. 修复投影

#### 重新投影图层
1. 右键点击需要修复的图层
2. 选择 "Export" → "Save Features As..."
3. 在 "Format" 下拉菜单中选择 "ESRI Shapefile"
4. 点击 "CRS" 按钮
5. 选择 "EPSG:4326 - WGS 84"
6. 设置输出文件名和路径
7. 点击 "OK"

#### 验证投影修复
1. 添加新投影的图层
2. 检查坐标值是否在合理范围内
   - 经度: -74.5 到 -73.5
   - 纬度: 40.5 到 40.9

## 缓冲区分析

### 1. 创建0.5英里缓冲区

#### 使用Vector工具
1. 点击 "Vector" → "Geoprocessing Tools" → "Buffer"
2. 在 "Input layer" 中选择设施点图层
3. 设置 "Distance" 为 "0.5 miles" 或 "804.672 meters"
4. 设置 "Segments" 为 "5" (平滑度)
5. 选择 "End cap style" 为 "Round"
6. 设置输出文件名
7. 点击 "Run"

#### 验证缓冲区
1. 检查缓冲区是否覆盖了预期的区域
2. 使用测量工具验证距离
3. 确保缓冲区没有重叠问题

### 2. 服务覆盖分析

#### 空间连接
1. 点击 "Vector" → "Data Management Tools" → "Join Attributes by Location"
2. 设置 "Target vector layer" 为人口普查区图层
3. 设置 "Join vector layer" 为缓冲区图层
4. 选择 "Intersects" 作为空间关系
5. 设置输出文件名
6. 点击 "Run"

#### 计算覆盖率
1. 打开属性表
2. 点击 "Field Calculator"
3. 创建新字段 "coverage_status"
4. 使用表达式：`CASE WHEN "facility_count" > 0 THEN 1 ELSE 0 END`
5. 点击 "OK"

## 地图制作

### 1. 设置地图布局

#### 创建新布局
1. 点击 "Project" → "New Print Layout"
2. 输入布局名称，如 "NYC_Facility_Analysis"
3. 点击 "OK"

#### 添加地图
1. 点击 "Add Map" 工具
2. 在布局中拖拽创建地图框架
3. 调整地图大小和位置

### 2. 样式设置

#### 设置设施密度样式
1. 右键点击图层 → "Properties"
2. 点击 "Symbology" 标签
3. 选择 "Graduated" 渲染器
4. 设置 "Column" 为 "facility_density_per1000"
5. 选择颜色方案，如 "Viridis"
6. 设置分类数量为 "5"
7. 点击 "Apply"

#### 设置服务覆盖样式
1. 选择 "Categorized" 渲染器
2. 设置 "Column" 为 "coverage_status"
3. 设置颜色：
   - 0 (无覆盖): 红色
   - 1 (有覆盖): 绿色
4. 点击 "Apply"

### 3. 添加地图元素

#### 添加标题
1. 点击 "Add Label" 工具
2. 在布局中点击添加标签
3. 输入标题文本
4. 设置字体大小和样式

#### 添加图例
1. 点击 "Add Legend" 工具
2. 在布局中拖拽创建图例
3. 调整图例位置和大小
4. 设置图例标题

#### 添加比例尺
1. 点击 "Add Scale Bar" 工具
2. 在布局中拖拽创建比例尺
3. 设置比例尺单位和样式

#### 添加指北针
1. 点击 "Add Picture" 工具
2. 选择指北针图片
3. 调整大小和位置

### 4. 导出地图

#### 导出为PNG
1. 点击 "Layout" → "Export as Image"
2. 设置输出文件名
3. 设置分辨率 (建议 300 DPI)
4. 设置图像尺寸
5. 点击 "Save"

#### 导出为PDF
1. 点击 "Layout" → "Export as PDF"
2. 设置输出文件名
3. 设置PDF选项
4. 点击 "Save"

## 质量控制

### 1. 数据验证

#### 检查几何有效性
1. 点击 "Vector" → "Geometry Tools" → "Check Validity"
2. 选择要检查的图层
3. 查看检查结果
4. 修复无效几何

#### 检查属性完整性
1. 打开属性表
2. 检查缺失值
3. 验证数据类型
4. 检查数值范围

### 2. 地图验证

#### 检查坐标系统
1. 确保所有图层使用相同坐标系统
2. 验证地图投影是否正确
3. 检查坐标值范围

#### 检查样式设置
1. 验证颜色方案是否合适
2. 检查分类是否合理
3. 确保图例信息准确

## 常见问题解决

### 1. 投影问题

#### 问题：图层不显示
**解决方案**：
1. 检查图层坐标系统
2. 重新投影到WGS84
3. 刷新地图画布

#### 问题：坐标值异常
**解决方案**：
1. 检查原始数据坐标系统
2. 确认投影转换参数
3. 验证坐标范围

### 2. 缓冲区问题

#### 问题：缓冲区过大或过小
**解决方案**：
1. 检查距离单位设置
2. 确认坐标系统
3. 重新计算缓冲区

#### 问题：缓冲区重叠
**解决方案**：
1. 使用 "Dissolve" 工具合并重叠区域
2. 检查原始数据质量
3. 调整缓冲区参数

### 3. 地图导出问题

#### 问题：图像质量差
**解决方案**：
1. 增加导出分辨率
2. 调整图像尺寸
3. 检查图层样式设置

#### 问题：文件过大
**解决方案**：
1. 降低分辨率
2. 压缩图像质量
3. 简化图层样式

## 最佳实践

### 1. 数据管理
- 保持原始数据不变
- 使用有意义的文件名
- 定期备份项目文件

### 2. 地图设计
- 使用合适的颜色方案
- 确保地图元素清晰可读
- 添加必要的图例和标注

### 3. 质量控制
- 定期检查数据质量
- 验证分析结果
- 记录处理步骤

---

**注意**: 本操作流程应与R脚本配合使用，确保分析过程的一致性和可重现性。QGIS操作可以作为R空间分析的补充或验证工具。 